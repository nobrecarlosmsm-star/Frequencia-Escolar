<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Frequ√™ncia Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @media print { .no-print { display: none !important; } }
        .header-gradient { background: linear-gradient(135deg, #5b5fc7 0%, #7c4dff 100%); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .toast { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const DEFAULT_USERS = { admin: { password: 'admin123', role: 'admin', name: 'Administrador Principal' } };
        const STUDENT_STATUS = { ATIVO: 'ativo', TRANSFERIDO: 'transferido', FALECIDO: 'falecido' };
        const ATTENDANCE_STATUS = { PRESENTE: 'presente', FALTA: 'falta', JUSTIFICADA: 'justificada' };
        const API_URL = 'https://api.jsonbin.io/v3';
        
        const SHARED_CONFIG = {
            apiKey: '$2a$10$r29w50G9LGhIwVWPD/zMHO9qrjIPioeXeRCxJ7nmnbicvocFkbLVm',
            binId: '698dac12d0ea881f40b4991f',
            keyType: 'access'  // 'master' = X-Master-Key | 'access' = X-Access-Key
        };
        
        function Toast({ message, type = 'success', onClose }) {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è';
            return (
                <div className={`fixed top-4 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl z-50 toast flex items-center gap-3`}>
                    <span className="text-2xl">{icon}</span>
                    <span className="font-semibold">{message}</span>
                </div>
            );
        }
        
        class CloudSync {
            static getKey() { return SHARED_CONFIG.apiKey || localStorage.getItem('jsonbin_api_key') || ''; }
            static getBinId() { return SHARED_CONFIG.binId || localStorage.getItem('syncBinId') || ''; }

            // Detecta automaticamente se √© Master Key ou Access Key
            // X-Master-Key come√ßa com $2a$10$ e tem ~53 chars
            // X-Access-Key tamb√©m come√ßa com $2a$10$ mas o JSONBin diferencia internamente
            // A forma mais confi√°vel: salvar o tipo junto com a chave
            static getKeyType() {
                return SHARED_CONFIG.keyType || localStorage.getItem('jsonbin_key_type') || 'master';
            }

            // Retorna o header de autentica√ß√£o correto conforme o tipo de chave
            static authHeader(key) {
                return this.getKeyType() === 'access'
                    ? { 'X-Access-Key': key }
                    : { 'X-Master-Key': key };
            }

            static async checkConnection() {
                try {
                    await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-cache' });
                    return true;
                } catch { return false; }
            }
            static async save(data) {
                const key = this.getKey();
                if (!key) return { success: false, error: 'Chave da API n√£o configurada' };
                const isOnline = await this.checkConnection();
                if (!isOnline) return { success: false, error: 'Sem conex√£o com a internet' };
                try {
                    const binId = this.getBinId();
                    const url = binId ? `${API_URL}/b/${binId}` : `${API_URL}/b`;
                    const res = await fetch(url, {
                        method: binId ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json', ...this.authHeader(key) },
                        body: JSON.stringify({ ...data, lastSync: new Date().toISOString() })
                    });
                    if (!res.ok) throw new Error('Erro na sincroniza√ß√£o');
                    const result = await res.json();
                    if (result.metadata?.id && !SHARED_CONFIG.binId) {
                        localStorage.setItem('syncBinId', result.metadata.id);
                    }
                    return { success: true, binId: result.metadata?.id };
                } catch (error) { return { success: false, error: error.message }; }
            }
            static async load() {
                const key = this.getKey();
                const binId = this.getBinId();
                if (!key || !binId) return null;
                const isOnline = await this.checkConnection();
                if (!isOnline) return null;
                try {
                    const res = await fetch(`${API_URL}/b/${binId}/latest`, { headers: { ...this.authHeader(key) } });
                    if (!res.ok) return null;
                    const result = await res.json();
                    return result.record;
                } catch { return null; }
            }
        }
        
        function App() {
            const [user, setUser] = useState(null);
            const [users, setUsers] = useState(DEFAULT_USERS);
            const [classes, setClasses] = useState([]);
            const [selectedClass, setSelectedClass] = useState(null);
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [showConfig, setShowConfig] = useState(false);
            const [showUsers, setShowUsers] = useState(false);
            const [showClasses, setShowClasses] = useState(false);
            const [showStudents, setShowStudents] = useState(false);
            const [syncing, setSyncing] = useState(false);
            const [lastSync, setLastSync] = useState(null);
            const [toast, setToast] = useState(null);
            const [isOnline, setIsOnline] = useState(true);
            const [isLoading, setIsLoading] = useState(true);
            
            useEffect(() => {
                const init = async () => {
                    await loadData();
                    await checkOnlineStatus();
                    await restoreSession();
                    setIsLoading(false);
                };
                init();
            }, []);
            
            useEffect(() => {
                if (!user) return;
                const interval = setInterval(() => autoSync(), 15000);
                return () => clearInterval(interval);
            }, [user, classes, users]);
            
            useEffect(() => {
                if (user) {
                    localStorage.setItem('userSession', JSON.stringify({
                        login: user.login,
                        role: user.role,
                        name: user.name,
                        canEdit: user.canEdit,
                        canManage: user.canManage
                    }));
                }
            }, [user]);
            
            const restoreSession = async () => {
                const savedSession = localStorage.getItem('userSession');
                if (!savedSession) return;
                try {
                    const sessionData = JSON.parse(savedSession);
                    if (CloudSync.getKey()) {
                        const cloudData = await CloudSync.load();
                        if (cloudData && cloudData.users) {
                            const cloudUser = cloudData.users[sessionData.login];
                            if (cloudUser) {
                                // Sempre recalcula canEdit e canManage pelo role atual da nuvem
                                const userData = {
                                    login: sessionData.login,
                                    ...cloudUser,
                                    canEdit: cloudUser.role === 'admin' || cloudUser.role === 'editor',
                                    canManage: cloudUser.role === 'admin'
                                };
                                setUser(userData);
                                setUsers(cloudData.users);
                                setClasses(cloudData.classes || []);
                                setLastSync(cloudData.lastSync);
                                return;
                            }
                        }
                    }
                    // Sem nuvem: recalcula pelo role salvo localmente
                    const userData = {
                        ...sessionData,
                        canEdit: sessionData.role === 'admin' || sessionData.role === 'editor',
                        canManage: sessionData.role === 'admin'
                    };
                    setUser(userData);
                } catch (e) {
                    localStorage.removeItem('userSession');
                }
            };
            
            const checkOnlineStatus = async () => {
                const online = await CloudSync.checkConnection();
                setIsOnline(online);
            };
            
            const showToast = (message, type = 'success') => setToast({ message, type });
            
            const loadData = async () => {
                const cloud = await CloudSync.load();
                if (cloud) {
                    setClasses(cloud.classes || []);
                    setUsers(cloud.users || DEFAULT_USERS);
                    setLastSync(cloud.lastSync);
                }
            };
            
            const autoSync = async () => {
                if (!CloudSync.getKey()) return;
                const result = await CloudSync.save({ classes, users });
                if (result.success) { setLastSync(new Date().toISOString()); setIsOnline(true); }
                else { setIsOnline(false); }
            };
            
            useEffect(() => {
                if (user && CloudSync.getKey()) {
                    const syncTimer = setTimeout(() => autoSync(), 2000);
                    return () => clearTimeout(syncTimer);
                }
            }, [users, classes]);
            
            const manualSync = async () => {
                setSyncing(true);
                await checkOnlineStatus();
                if (!isOnline) { showToast('Sem conex√£o com a internet!', 'error'); setSyncing(false); return; }
                if (!CloudSync.getKey()) { showToast('Configure a chave da API primeiro!', 'error'); setSyncing(false); return; }
                const result = await CloudSync.save({ classes, users });
                if (result.success) {
                    setLastSync(new Date().toISOString());
                    if (result.binId && !SHARED_CONFIG.binId) {
                        showToast('‚úÖ Sincronizado! IMPORTANTE: Veja o console para o BIN ID', 'success');
                        alert(`üîë IMPORTANTE!\n\nSeu BIN ID foi gerado:\n${result.binId}\n\nAdicione em SHARED_CONFIG no c√≥digo!`);
                    } else {
                        showToast('Dados sincronizados com sucesso!', 'success');
                    }
                } else {
                    showToast(`Erro na sincroniza√ß√£o: ${result.error}`, 'error');
                }
                setTimeout(() => setSyncing(false), 1000);
            };
            
            const handleLogin = async (e) => {
                e.preventDefault();
                const fd = new FormData(e.target);
                const login = fd.get('login');
                const pass = fd.get('password');
                await checkOnlineStatus();
                if (CloudSync.getKey()) {
                    if (!isOnline) { showToast('Sem conex√£o com a internet! √â necess√°rio estar online para fazer login.', 'error'); return; }
                    const cloudData = await CloudSync.load();
                    if (cloudData) {
                        const cloudUsers = cloudData.users || DEFAULT_USERS;
                        const u = cloudUsers[login];
                        if (u && u.password === pass) {
                            setUsers(cloudUsers);
                            setClasses(cloudData.classes || []);
                            setLastSync(cloudData.lastSync);
                            const userData = { login, ...u, canEdit: u.role === 'admin' || u.role === 'editor', canManage: u.role === 'admin' };
                            setUser(userData);
                            showToast(`Bem-vindo, ${u.name}!`, 'success');
                        } else { showToast('Login ou senha incorretos!', 'error'); }
                    } else {
                        const u = users[login];
                        if (u && u.password === pass) {
                            const userData = { login, ...u, canEdit: u.role === 'admin' || u.role === 'editor', canManage: u.role === 'admin' };
                            setUser(userData);
                            showToast(`Bem-vindo, ${u.name}!`, 'success');
                        } else { showToast('N√£o foi poss√≠vel carregar os dados da nuvem.', 'error'); }
                    }
                } else {
                    const u = users[login];
                    if (u && u.password === pass) {
                        const userData = { login, ...u, canEdit: u.role === 'admin' || u.role === 'editor', canManage: u.role === 'admin' };
                        setUser(userData);
                        showToast(`Bem-vindo, ${u.name}!`, 'success');
                    } else { showToast('Login ou senha incorretos!', 'error'); }
                }
            };
            
            const handleLogout = () => {
                localStorage.removeItem('userSession');
                setUser(null);
                showToast('Logout realizado com sucesso!', 'success');
            };
            
            if (isLoading) {
                return (
                    <div className="min-h-screen header-gradient flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-4 animate-spin">‚ü≥</div>
                            <p className="text-white text-xl font-bold">Carregando...</p>
                        </div>
                    </div>
                );
            }
            
            if (!user) {
                return (
                    <>
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        <div className="min-h-screen header-gradient flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                                <div className="text-center mb-8">
                                    <h1 className="text-4xl font-bold text-indigo-600 mb-2">üìö Frequ√™ncia Escolar</h1>
                                    <p className="text-gray-600">Sistema de Controle de Frequ√™ncia</p>
                                    {!isOnline && (
                                        <div className="mt-4 bg-red-100 text-red-700 px-4 py-2 rounded-lg text-sm">‚ö†Ô∏è Sem conex√£o com a internet</div>
                                    )}
                                </div>
                                <form onSubmit={handleLogin} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">üë§ Login</label>
                                        <input name="login" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-2">üîí Senha</label>
                                        <input name="password" type="password" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-indigo-500 outline-none" required />
                                    </div>
                                    <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">ENTRAR</button>
                                </form>
                            </div>
                        </div>
                    </>
                );
            }
            
            const cls = classes.find(c => c.id === selectedClass);
            const roleLabel = user.role === 'admin' ? 'Administrador' : user.role === 'editor' ? 'Editor' : 'Visualizador';
            
            return (
                <div className="min-h-screen">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    
                    <div className="header-gradient text-white p-6 shadow-lg no-print">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold">üìö Frequ√™ncia Escolar</h1>
                                    <p className="text-indigo-200 mt-1">üë§ {user.name} ({roleLabel})</p>
                                </div>
                                <div className="flex gap-3 items-center">
                                    {!isOnline && <div className="bg-red-500 px-4 py-2 rounded-lg text-sm font-semibold">‚ö†Ô∏è Offline</div>}
                                    {lastSync && (
                                        <div className="text-sm bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                                            üì° √öltima sync: {new Date(lastSync).toLocaleString('pt-BR')}
                                        </div>
                                    )}
                                    <button onClick={manualSync} disabled={syncing}
                                        className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-indigo-50 transition disabled:opacity-50 flex items-center gap-2">
                                        {syncing ? <span className="animate-spin">‚ü≥</span> : 'üîÑ'} Sincronizar
                                    </button>
                                    {user.canManage && (
                                        <button onClick={() => setShowConfig(true)}
                                            className="bg-white text-indigo-600 px-6 py-2 rounded-lg font-bold hover:bg-indigo-50 transition">
                                            ‚öôÔ∏è Configurar
                                        </button>
                                    )}
                                    <button onClick={handleLogout} className="bg-red-500 px-6 py-2 rounded-lg font-bold hover:bg-red-600 transition">üö™ Sair</button>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 flex-wrap">
                                <button onClick={() => setActiveTab('dashboard')}
                                    className={`px-6 py-3 rounded-lg font-bold transition ${activeTab === 'dashboard' ? 'bg-white text-indigo-600' : 'bg-indigo-500 hover:bg-indigo-400'}`}>
                                    üìä Dashboard
                                </button>
                                <button onClick={() => setActiveTab('frequency')}
                                    className={`px-6 py-3 rounded-lg font-bold transition ${activeTab === 'frequency' ? 'bg-white text-indigo-600' : 'bg-indigo-500 hover:bg-indigo-400'}`}>
                                    ‚úÖ Frequ√™ncia
                                </button>
                                <button onClick={() => setActiveTab('reports')}
                                    className={`px-6 py-3 rounded-lg font-bold transition ${activeTab === 'reports' ? 'bg-white text-indigo-600' : 'bg-indigo-500 hover:bg-indigo-400'}`}>
                                    üìà Relat√≥rios
                                </button>
                                {/* Hist√≥rico: apenas admin */}
                                {user.canManage && (
                                    <button onClick={() => setActiveTab('history')}
                                        className={`px-6 py-3 rounded-lg font-bold transition ${activeTab === 'history' ? 'bg-white text-indigo-600' : 'bg-indigo-500 hover:bg-indigo-400'}`}>
                                        üìã Hist√≥rico
                                    </button>
                                )}
                                {/* Turmas e Usu√°rios: apenas admin */}
                                {user.canManage && (
                                    <>
                                        <button onClick={() => setShowClasses(true)}
                                            className="bg-green-500 px-6 py-3 rounded-lg font-bold hover:bg-green-400 transition">
                                            üè´ Turmas
                                        </button>
                                        <button onClick={() => setShowUsers(true)}
                                            className="bg-yellow-500 px-6 py-3 rounded-lg font-bold hover:bg-yellow-400 transition">
                                            üë• Usu√°rios
                                        </button>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    <div className="max-w-7xl mx-auto p-6">
                        {activeTab === 'dashboard' && <Dashboard classes={classes} />}
                        {activeTab === 'frequency' && (
                            <Frequency
                                classes={classes}
                                setClasses={setClasses}
                                selectedClass={selectedClass}
                                setSelectedClass={setSelectedClass}
                                selectedDate={selectedDate}
                                setSelectedDate={setSelectedDate}
                                canEdit={user.canEdit}
                                canManage={user.canManage}
                                setShowStudents={setShowStudents}
                                showToast={showToast}
                            />
                        )}
                        {activeTab === 'reports' && <Reports classes={classes} showToast={showToast} canManage={user.canManage} />}
                        {activeTab === 'history' && user.canManage && <History classes={classes} showToast={showToast} />}
                    </div>
                    
                    {showConfig && <ConfigModal onClose={() => setShowConfig(false)} showToast={showToast} />}
                    {showUsers && <UsersModal users={users} setUsers={setUsers} onClose={() => setShowUsers(false)} showToast={showToast} />}
                    {showClasses && <ClassesModal classes={classes} setClasses={setClasses} onClose={() => setShowClasses(false)} showToast={showToast} />}
                    {showStudents && cls && <StudentsModal class={cls} classes={classes} setClasses={setClasses} onClose={() => setShowStudents(false)} showToast={showToast} />}
                </div>
            );
        }
        
        function Dashboard({ classes }) {
            const totalStudents = classes.reduce((sum, c) => sum + c.students.filter(s => s.status === 'ativo').length, 0);
            const today = new Date().toISOString().split('T')[0];
            let totalPresent = 0, totalAbsent = 0, totalJustified = 0;
            classes.forEach(c => {
                c.students.filter(s => s.status === 'ativo').forEach(s => {
                    const att = s.attendance?.[today];
                    if (att === 'presente') totalPresent++;
                    else if (att === 'falta') totalAbsent++;
                    else if (att === 'justificada') totalJustified++;
                });
            });
            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <div className="text-3xl mb-2">üè´</div>
                        <div className="text-gray-600 text-sm mb-1">Total de Turmas</div>
                        <div className="text-3xl font-bold text-indigo-600">{classes.length}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500">
                        <div className="text-3xl mb-2">üë®‚Äçüéì</div>
                        <div className="text-gray-600 text-sm mb-1">Alunos Ativos</div>
                        <div className="text-3xl font-bold text-blue-600">{totalStudents}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                        <div className="text-3xl mb-2">‚úÖ</div>
                        <div className="text-gray-600 text-sm mb-1">Presentes Hoje</div>
                        <div className="text-3xl font-bold text-green-600">{totalPresent}</div>
                    </div>
                    <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                        <div className="text-3xl mb-2">‚ùå</div>
                        <div className="text-gray-600 text-sm mb-1">Faltas Hoje</div>
                        <div className="text-3xl font-bold text-red-600">{totalAbsent}</div>
                    </div>
                    <div className="col-span-full bg-white p-6 rounded-xl shadow-lg">
                        <h3 className="text-xl font-bold mb-4">üìä Vis√£o Geral das Turmas</h3>
                        <div className="space-y-3">
                            {classes.map(c => {
                                const activeStudents = c.students.filter(s => s.status === 'ativo');
                                const present = activeStudents.filter(s => s.attendance?.[today] === 'presente').length;
                                const percentage = activeStudents.length > 0 ? ((present / activeStudents.length) * 100).toFixed(0) : 0;
                                return (
                                    <div key={c.id} className="border-2 rounded-lg p-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold text-lg">{c.name}</span>
                                            <span className="text-sm text-gray-600">{activeStudents.length} aluno(s) ativo(s)</span>
                                        </div>
                                        <div className="bg-gray-200 rounded-full h-4 overflow-hidden">
                                            <div className="bg-green-500 h-full transition-all" style={{ width: `${percentage}%` }}></div>
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">{percentage}% de presen√ßa hoje</div>
                                    </div>
                                );
                            })}
                            {classes.length === 0 && <p className="text-gray-500 text-center py-8">Nenhuma turma cadastrada ainda</p>}
                        </div>
                    </div>
                </div>
            );
        }
        
        // canManage controla o bot√£o "Gerenciar Alunos"
        function Frequency({ classes, setClasses, selectedClass, setSelectedClass, selectedDate, setSelectedDate, canEdit, canManage, setShowStudents, showToast }) {
            const cls = classes.find(c => c.id === selectedClass);

            // Mesma l√≥gica de ordena√ß√£o do StudentsModal: normais alfab√©tico, p√≥s-censo no final
            const sortedActiveStudents = (students) => {
                const ativos = students.filter(s => s.status === 'ativo');
                const normais = ativos.filter(s => !s.posCenso).sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                const pc     = ativos.filter(s =>  s.posCenso).sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
                return [...normais, ...pc];
            };

            const handleAttendance = (studentId, status) => {
                if (!canEdit) return;
                setClasses(classes.map(c =>
                    c.id === selectedClass
                        ? { ...c, students: c.students.map(s => s.id === studentId ? { ...s, attendance: { ...s.attendance, [selectedDate]: status } } : s) }
                        : c
                ));
            };

            // Desmarcar: remove a chave da data no attendance ‚Äî apenas admin
            const handleClear = (studentId) => {
                if (!canManage) return;
                setClasses(classes.map(c => {
                    if (c.id !== selectedClass) return c;
                    return {
                        ...c,
                        students: c.students.map(s => {
                            if (s.id !== studentId) return s;
                            const newAtt = { ...s.attendance };
                            delete newAtt[selectedDate];
                            return { ...s, attendance: newAtt };
                        })
                    };
                }));
                showToast('Marca√ß√£o removida com sucesso!', 'success');
            };

            const handleObservation = (studentId, obs) => {
                if (!canEdit) return;
                setClasses(classes.map(c =>
                    c.id === selectedClass
                        ? { ...c, students: c.students.map(s => s.id === studentId ? { ...s, observations: { ...s.observations, [selectedDate]: obs } } : s) }
                        : c
                ));
            };

            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-4">‚úÖ Controle de Frequ√™ncia</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Selecione a Turma:</label>
                                <select value={selectedClass || ''} onChange={(e) => setSelectedClass(Number(e.target.value))}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                    <option value="">-- Escolha uma turma --</option>
                                    {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üìÖ Data:</label>
                                <input type="date" value={selectedDate} onChange={(e) => setSelectedDate(e.target.value)}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                        </div>

                        {/* Bot√£o Gerenciar Alunos: apenas admin */}
                        {cls && canManage && (
                            <div className="flex justify-end mb-4">
                                <button onClick={() => setShowStudents(true)}
                                    className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                                    üë®‚Äçüéì Gerenciar Alunos
                                </button>
                            </div>
                        )}
                    </div>

                    {cls ? (
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-bold mb-4">üë• Lista de Chamada - {cls.name}</h3>
                            <p className="text-sm text-gray-600 mb-4">
                                üìÖ {new Date(selectedDate + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                            </p>

                            {/* Banner informativo para visualizador */}
                            {!canEdit && (
                                <div className="mb-4 bg-blue-50 border-2 border-blue-200 rounded-lg px-4 py-3 text-blue-700 text-sm font-semibold">
                                    üëÅÔ∏è Modo visualiza√ß√£o ‚Äî voc√™ pode acompanhar a frequ√™ncia mas n√£o pode edit√°-la.
                                </div>
                            )}

                            {sortedActiveStudents(cls.students).length === 0 ? (
                                <p className="text-gray-500 text-center py-8">Nenhum aluno ativo nesta turma</p>
                            ) : (
                                <div className="space-y-3">
                                    {sortedActiveStudents(cls.students).map((student, idx) => {
                                        const marcacao = student.attendance?.[selectedDate];
                                        const jaMarcado = !!marcacao;
                                        return (
                                            <div key={student.id} className={`border-2 rounded-lg p-4 hover:bg-gray-50 transition ${student.posCenso ? 'border-yellow-300 bg-yellow-50' : ''}`}>
                                                <div className="flex items-center gap-3 mb-3 flex-wrap">
                                                    <span className="font-bold text-lg bg-indigo-100 w-10 h-10 rounded-full flex items-center justify-center shrink-0">{idx + 1}</span>
                                                    <span className="flex-1 font-bold text-lg">
                                                        {student.name}
                                                        {student.posCenso && <span className="ml-2 text-xs bg-yellow-500 text-white px-2 py-0.5 rounded-full">P√ìS-CENSO</span>}
                                                    </span>
                                                    <div className="flex gap-2 flex-wrap">
                                                        <button onClick={() => handleAttendance(student.id, 'presente')} disabled={!canEdit}
                                                            className={`px-5 py-2 rounded-lg font-bold transition ${marcacao === 'presente' ? 'bg-green-600 text-white ring-2 ring-green-400' : 'bg-gray-200 hover:bg-green-100'} ${!canEdit && 'opacity-60 cursor-not-allowed'}`}>
                                                            ‚úÖ Presente
                                                        </button>
                                                        <button onClick={() => handleAttendance(student.id, 'falta')} disabled={!canEdit}
                                                            className={`px-5 py-2 rounded-lg font-bold transition ${marcacao === 'falta' ? 'bg-red-600 text-white ring-2 ring-red-400' : 'bg-gray-200 hover:bg-red-100'} ${!canEdit && 'opacity-60 cursor-not-allowed'}`}>
                                                            ‚ùå Falta
                                                        </button>
                                                        <button onClick={() => handleAttendance(student.id, 'justificada')} disabled={!canEdit}
                                                            className={`px-5 py-2 rounded-lg font-bold transition ${marcacao === 'justificada' ? 'bg-yellow-600 text-white ring-2 ring-yellow-400' : 'bg-gray-200 hover:bg-yellow-100'} ${!canEdit && 'opacity-60 cursor-not-allowed'}`}>
                                                            üìù Justificada
                                                        </button>
                                                        {/* Bot√£o desmarcar: s√≥ aparece para admin E quando h√° algo marcado */}
                                                        {canManage && jaMarcado && (
                                                            <button onClick={() => handleClear(student.id)}
                                                                title="Remover marca√ß√£o desta data"
                                                                className="px-4 py-2 rounded-lg font-bold bg-gray-100 text-gray-500 border-2 border-dashed border-gray-400 hover:bg-gray-200 hover:text-gray-700 transition">
                                                                üö´ Desmarcar
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">üìù Observa√ß√µes:</label>
                                                    <textarea value={student.observations?.[selectedDate] || ''}
                                                        onChange={(e) => handleObservation(student.id, e.target.value)}
                                                        disabled={!canEdit}
                                                        placeholder={canEdit ? "Adicione observa√ß√µes sobre o aluno..." : "Sem observa√ß√µes"}
                                                        className={`w-full px-3 py-2 border-2 rounded-lg focus:border-indigo-500 outline-none resize-none ${!canEdit && 'bg-gray-50 cursor-not-allowed'}`}
                                                        rows="2"></textarea>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="bg-white p-12 rounded-xl shadow-lg text-center">
                            <div className="text-6xl mb-4">üè´</div>
                            <p className="text-xl text-gray-600">Selecione uma turma para come√ßar</p>
                        </div>
                    )}
                </div>
            );
        }
        
        // canManage controla visibilidade dos bot√µes PDF
        function Reports({ classes, showToast, canManage }) {
            const [selectedClass, setSelectedClass] = useState(null);
            const [startDate, setStartDate] = useState(new Date(new Date().setDate(1)).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [showStudentModal, setShowStudentModal] = useState(false);
            const [expandedStudent, setExpandedStudent] = useState(null);

            const cls = classes.find(c => c.id === selectedClass);

            const fmtDate = (iso) => new Date(iso + 'T00:00:00').toLocaleDateString('pt-BR');

            const generateReport = () => {
                if (!cls) return null;
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                const days = [];
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) days.push(d.toISOString().split('T')[0]);
                return cls.students.filter(s => s.status === 'ativo').map(student => {
                    let presente = 0, falta = 0, justificada = 0;
                    const faltaDates = [], justificadaDates = [];
                    // S√≥ conta dias a partir da data de matr√≠cula do aluno
                    const enrollDate = student.enrollDate || null;
                    const enrollLimit = enrollDate ? new Date(enrollDate + 'T00:00:00') : null;
                    days.forEach(day => {
                        // Pula dias anteriores √† matr√≠cula
                        if (enrollLimit && new Date(day + 'T00:00:00') < enrollLimit) return;
                        const att = student.attendance?.[day];
                        if (att === 'presente') presente++;
                        else if (att === 'falta') { falta++; faltaDates.push(day); }
                        else if (att === 'justificada') { justificada++; justificadaDates.push(day); }
                    });
                    const total = presente + falta + justificada;
                    const percentage = total > 0 ? ((presente / total) * 100).toFixed(1) : 0;
                    return { student, presente, falta, justificada, total, percentage, days, faltaDates, justificadaDates, enrollDate };
                });
            };
            
            const report = generateReport();
            
            const generateIndividualPDF = () => {
                if (!selectedStudent || !report) return;
                const studentData = report.find(r => r.student.id === selectedStudent);
                if (!studentData) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18); doc.setFont(undefined, 'bold');
                doc.text('Relat√≥rio Individual de Frequ√™ncia', 105, 18, { align: 'center' });
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                doc.text(`Turma: ${cls.name}`, 20, 30);
                doc.text(`Per√≠odo: ${fmtDate(startDate)} a ${fmtDate(endDate)}`, 20, 37);
                doc.setFontSize(14); doc.setFont(undefined, 'bold');
                doc.text(`Aluno: ${studentData.student.name}`, 20, 48);

                // Resumo
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                const enrollInfo = studentData.enrollDate ? `Data de Matr√≠cula: ${fmtDate(studentData.enrollDate)}` : 'Data de Matr√≠cula: N√£o informada';
                doc.text(enrollInfo, 20, 57);
                const calcFrom = studentData.enrollDate && new Date(studentData.enrollDate + 'T00:00:00') > new Date(startDate + 'T00:00:00')
                    ? `(frequ√™ncia calculada a partir de ${fmtDate(studentData.enrollDate)})` : '';
                if (calcFrom) { doc.setTextColor(180, 90, 0); doc.text(calcFrom, 20, 63); doc.setTextColor(0,0,0); }
                doc.text(`Presen√ßas: ${studentData.presente}`, 20, calcFrom ? 72 : 65);
                doc.text(`Faltas: ${studentData.falta}`, 20, 67);
                doc.text(`Justificadas: ${studentData.justificada}`, 20, 74);
                doc.text(`Total de Aulas Registradas: ${studentData.total}`, 20, 81);
                doc.text(`Percentual de Presen√ßa: ${studentData.percentage}%`, 20, 88);
                const status = parseFloat(studentData.percentage) >= 75 ? 'APROVADO' : 'REPROVADO por falta';
                doc.setFontSize(13); doc.setFont(undefined, 'bold');
                doc.setTextColor(parseFloat(studentData.percentage) >= 75 ? 0 : 200, parseFloat(studentData.percentage) >= 75 ? 140 : 0, 0);
                doc.text(`Situa√ß√£o: ${status}`, 20, 98);
                doc.setTextColor(0, 0, 0);

                let curY = 112;

                // Tabela de datas de faltas
                if (studentData.faltaDates.length > 0) {
                    doc.setFontSize(12); doc.setFont(undefined, 'bold');
                    doc.setTextColor(200, 0, 0);
                    doc.text(`‚ùå Datas de Falta (${studentData.faltaDates.length}):`, 20, curY);
                    doc.setTextColor(0, 0, 0);
                    curY += 6;
                    const faltaRows = studentData.faltaDates.map((d, i) => [i + 1, fmtDate(d)]);
                    doc.autoTable({
                        startY: curY,
                        head: [['#', 'Data']],
                        body: faltaRows,
                        theme: 'grid',
                        headStyles: { fillColor: [220, 53, 69], fontSize: 9, fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: { 0: { cellWidth: 15, halign: 'center' }, 1: { cellWidth: 45 } },
                        margin: { left: 20 },
                        tableWidth: 60
                    });
                    curY = doc.lastAutoTable.finalY + 8;
                }

                // Tabela de datas justificadas
                if (studentData.justificadaDates.length > 0) {
                    if (curY > 240) { doc.addPage(); curY = 20; }
                    doc.setFontSize(12); doc.setFont(undefined, 'bold');
                    doc.setTextColor(180, 120, 0);
                    doc.text(`üìù Datas Justificadas (${studentData.justificadaDates.length}):`, 20, curY);
                    doc.setTextColor(0, 0, 0);
                    curY += 6;
                    const justRows = studentData.justificadaDates.map((d, i) => [i + 1, fmtDate(d)]);
                    doc.autoTable({
                        startY: curY,
                        head: [['#', 'Data']],
                        body: justRows,
                        theme: 'grid',
                        headStyles: { fillColor: [202, 138, 4], fontSize: 9, fontStyle: 'bold' },
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: { 0: { cellWidth: 15, halign: 'center' }, 1: { cellWidth: 45 } },
                        margin: { left: 20 },
                        tableWidth: 60
                    });
                }

                doc.save(`relatorio_${studentData.student.name.replace(/\s/g, '_')}.pdf`);
                showToast('PDF Individual gerado com sucesso!', 'success');
                setShowStudentModal(false);
            };
            
            const generateClassPDF = () => {
                if (!report) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });

                doc.setFontSize(16); doc.setFont(undefined, 'bold');
                doc.text('Relat√≥rio de Frequ√™ncia da Turma', 148, 14, { align: 'center' });
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                doc.text(`Turma: ${cls.name}     Per√≠odo: ${fmtDate(startDate)} a ${fmtDate(endDate)}`, 148, 22, { align: 'center' });

                const tableData = report.map((r, idx) => [
                    idx + 1,
                    r.student.name,
                    r.enrollDate ? fmtDate(r.enrollDate) : '-',
                    r.presente,
                    r.falta,
                    r.faltaDates.length > 0 ? r.faltaDates.map(d => fmtDate(d)).join(', ') : '-',
                    r.justificada,
                    r.justificadaDates.length > 0 ? r.justificadaDates.map(d => fmtDate(d)).join(', ') : '-',
                    r.total,
                    `${r.percentage}%`
                ]);

                doc.autoTable({
                    startY: 27,
                    head: [['#', 'Aluno', 'Matr√≠cula', 'Pres.', 'Faltas', 'Datas das Faltas', 'Just.', 'Datas Justificadas', 'Total', '%']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [91, 95, 199], fontSize: 8, fontStyle: 'bold' },
                    styles: { fontSize: 7.5, cellPadding: 2.5, overflow: 'linebreak' },
                    columnStyles: {
                        0: { cellWidth: 8, halign: 'center' },
                        1: { cellWidth: 42 },
                        2: { cellWidth: 22, halign: 'center' },
                        3: { cellWidth: 11, halign: 'center' },
                        4: { cellWidth: 11, halign: 'center' },
                        5: { cellWidth: 48 },
                        6: { cellWidth: 11, halign: 'center' },
                        7: { cellWidth: 48 },
                        8: { cellWidth: 11, halign: 'center' },
                        9: { cellWidth: 14, halign: 'center' }
                    },
                    didParseCell: (data) => {
                        if (data.column.index === 4 && data.section === 'body') {
                            const val = parseInt(data.cell.raw);
                            if (val > 0) data.cell.styles.textColor = [200, 0, 0];
                        }
                        if (data.column.index === 6 && data.section === 'body') {
                            const val = parseInt(data.cell.raw);
                            if (val > 0) data.cell.styles.textColor = [150, 100, 0];
                        }
                        if (data.column.index === 9 && data.section === 'body') {
                            const val = parseFloat(data.cell.raw);
                            data.cell.styles.textColor = val >= 75 ? [0, 140, 0] : [200, 0, 0];
                            data.cell.styles.fontStyle = 'bold';
                        }
                    }
                });

                const finalY = doc.lastAutoTable.finalY + 8;
                doc.setFontSize(9);
                doc.text(`Total de Presen√ßas: ${report.reduce((sum, r) => sum + r.presente, 0)}   |   Total de Faltas: ${report.reduce((sum, r) => sum + r.falta, 0)}   |   Total de Justificadas: ${report.reduce((sum, r) => sum + r.justificada, 0)}`, 20, finalY);

                doc.save(`relatorio_turma_${cls.name.replace(/\s/g, '_')}.pdf`);
                showToast('PDF da Turma gerado com sucesso!', 'success');
            };
            
            const generatePeriodPDF = () => {
                if (!report) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                doc.setFontSize(18); doc.setFont(undefined, 'bold');
                doc.text('Relat√≥rio de Frequ√™ncia por Per√≠odo', 105, 15, { align: 'center' });
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                doc.text(`Turma: ${cls.name}`, 105, 23, { align: 'center' });
                doc.text(`Per√≠odo: ${diffDays + 1} dias (${new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR')})`, 105, 29, { align: 'center' });
                const totalPresencas = report.reduce((sum, r) => sum + r.presente, 0);
                const totalFaltas = report.reduce((sum, r) => sum + r.falta, 0);
                const totalJustificadas = report.reduce((sum, r) => sum + r.justificada, 0);
                const totalAulas = report.reduce((sum, r) => sum + r.total, 0);
                const mediaPresenca = totalAulas > 0 ? ((totalPresencas / totalAulas) * 100).toFixed(1) : 0;
                doc.setFontSize(12); doc.setFont(undefined, 'bold'); doc.text('Estat√≠sticas do Per√≠odo:', 20, 45);
                doc.setFont(undefined, 'normal'); doc.setFontSize(11);
                doc.text(`Total de Presen√ßas: ${totalPresencas}`, 20, 55);
                doc.text(`Total de Faltas: ${totalFaltas}`, 20, 62);
                doc.text(`Total de Justificadas: ${totalJustificadas}`, 20, 69);
                doc.text(`M√©dia de Presen√ßa da Turma: ${mediaPresenca}%`, 20, 76);
                doc.text(`N√∫mero de Alunos Ativos: ${report.length}`, 20, 83);
                const tableData = report.map((r, idx) => [idx + 1, r.student.name, `${r.percentage}%`, parseFloat(r.percentage) >= 75 ? 'OK' : 'ATEN√á√ÉO']);
                doc.autoTable({ startY: 95, head: [['#', 'Aluno', '% Presen√ßa', 'Status']], body: tableData, theme: 'grid', headStyles: { fillColor: [255, 140, 0], fontSize: 10, fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 3 } });
                doc.save(`relatorio_periodo_${cls.name.replace(/\s/g, '_')}.pdf`);
                showToast('PDF por Per√≠odo gerado com sucesso!', 'success');
            };
            
            const generateGraphPDF = () => {
                if (!report) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.setFont(undefined, 'bold');
                doc.text('Relat√≥rio com Estat√≠sticas Visuais', 105, 15, { align: 'center' });
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                doc.text(`Turma: ${cls.name}`, 105, 23, { align: 'center' });
                doc.text(`Per√≠odo: ${new Date(startDate + 'T00:00:00').toLocaleDateString('pt-BR')} a ${new Date(endDate + 'T00:00:00').toLocaleDateString('pt-BR')}`, 105, 29, { align: 'center' });
                const totalPresencas = report.reduce((sum, r) => sum + r.presente, 0);
                const totalFaltas = report.reduce((sum, r) => sum + r.falta, 0);
                const totalJustificadas = report.reduce((sum, r) => sum + r.justificada, 0);
                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Distribui√ß√£o Geral:', 20, 45);
                const total = totalPresencas + totalFaltas + totalJustificadas;
                const percPresenca = total > 0 ? ((totalPresencas / total) * 100).toFixed(1) : 0;
                const percFalta = total > 0 ? ((totalFaltas / total) * 100).toFixed(1) : 0;
                const percJust = total > 0 ? ((totalJustificadas / total) * 100).toFixed(1) : 0;
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 128, 0); doc.text(`Presen√ßas: ${totalPresencas} (${percPresenca}%)`, 20, 55);
                doc.setTextColor(255, 0, 0); doc.text(`Faltas: ${totalFaltas} (${percFalta}%)`, 20, 62);
                doc.setTextColor(255, 165, 0); doc.text(`Justificadas: ${totalJustificadas} (${percJust}%)`, 20, 69);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.text('Ranking de Frequ√™ncia:', 20, 85);
                const sorted = [...report].sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
                doc.setFontSize(10); doc.setFont(undefined, 'normal');
                sorted.slice(0, 5).forEach((r, idx) => {
                    const medal = idx === 0 ? '1o' : idx === 1 ? '2o' : idx === 2 ? '3o' : '';
                    doc.text(`${idx + 1}. ${r.student.name}: ${r.percentage}% ${medal}`, 20, 95 + (idx * 7));
                });
                const emRisco = report.filter(r => parseFloat(r.percentage) < 75);
                if (emRisco.length > 0) {
                    doc.setFontSize(14); doc.setFont(undefined, 'bold'); doc.setTextColor(255, 0, 0);
                    doc.text(`Alunos em Risco (< 75%): ${emRisco.length}`, 20, 135);
                    doc.setFontSize(10); doc.setFont(undefined, 'normal');
                    emRisco.slice(0, 5).forEach((r, idx) => { doc.text(`- ${r.student.name}: ${r.percentage}%`, 20, 145 + (idx * 7)); });
                }
                doc.setTextColor(0, 0, 0);
                doc.save(`relatorio_graficos_${cls.name.replace(/\s/g, '_')}.pdf`);
                showToast('PDF com Gr√°ficos gerado com sucesso!', 'success');
            };
            
            const generateAttendanceSheet = () => {
                if (!cls) return;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18); doc.setFont(undefined, 'bold');
                doc.text('Folha de Presen√ßa', 105, 15, { align: 'center' });
                doc.setFontSize(11); doc.setFont(undefined, 'normal');
                doc.text(`Turma: ${cls.name}`, 20, 25);
                doc.text(`Data: ___/___/_____`, 20, 32);
                doc.text(`Professor: _________________________________`, 20, 39);
                const activeStudents = cls.students.filter(s => s.status === 'ativo');
                const tableData = activeStudents.map((s, idx) => [idx + 1, s.name, '', '']);
                doc.autoTable({ startY: 50, head: [['#', 'Nome do Aluno', 'Presente', 'Falta']], body: tableData, theme: 'grid', headStyles: { fillColor: [0, 128, 128], fontSize: 11, fontStyle: 'bold' }, styles: { fontSize: 10, cellPadding: 5, minCellHeight: 12 } });
                const finalY = doc.lastAutoTable.finalY + 15;
                doc.setFontSize(9);
                doc.text('Assinatura do Professor: _________________________________', 20, finalY);
                doc.text(`Total de Alunos: ${activeStudents.length}`, 20, finalY + 10);
                doc.save(`folha_presenca_${cls.name.replace(/\s/g, '_')}.pdf`);
                showToast('Folha de Presen√ßa gerada com sucesso!', 'success');
            };
            
            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg no-print">
                        <h2 className="text-2xl font-bold mb-4">üìà Relat√≥rios de Frequ√™ncia</h2>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Turma:</label>
                                <select value={selectedClass || ''} onChange={(e) => setSelectedClass(Number(e.target.value))}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                    <option value="">-- Escolha uma turma --</option>
                                    {classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üìÖ Data In√≠cio:</label>
                                <input type="date" value={startDate} onChange={(e) => setStartDate(e.target.value)}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üìÖ Data Fim:</label>
                                <input type="date" value={endDate} onChange={(e) => setEndDate(e.target.value)}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none" />
                            </div>
                        </div>
                        
                        {/* Bloco PDF: apenas admin */}
                        {report && canManage && (
                            <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200 mt-4">
                                <h3 className="text-xl font-bold mb-4 text-purple-800">üìÑ Exportar para PDF</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                    <button onClick={() => setShowStudentModal(true)} className="bg-blue-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üë§</span>
                                        <div className="text-left"><div className="text-sm">Relat√≥rio</div><div>Individual</div></div>
                                    </button>
                                    <button onClick={generateClassPDF} className="bg-green-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-green-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üë•</span>
                                        <div className="text-left"><div className="text-sm">Relat√≥rio</div><div>Turma Completa</div></div>
                                    </button>
                                    <button onClick={generatePeriodPDF} className="bg-orange-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-orange-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üìÖ</span>
                                        <div className="text-left"><div className="text-sm">Relat√≥rio</div><div>Por Per√≠odo</div></div>
                                    </button>
                                    <button onClick={generateGraphPDF} className="bg-purple-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-purple-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üìä</span>
                                        <div className="text-left"><div className="text-sm">Relat√≥rio com</div><div>Gr√°ficos</div></div>
                                    </button>
                                    <button onClick={generateAttendanceSheet} className="bg-teal-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-teal-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üìã</span>
                                        <div className="text-left"><div className="text-sm">Folha de</div><div>Presen√ßa</div></div>
                                    </button>
                                    <button onClick={() => window.print()} className="bg-indigo-600 text-white px-6 py-4 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg flex items-center justify-center gap-2">
                                        <span className="text-2xl">üñ®Ô∏è</span>
                                        <div className="text-left"><div className="text-sm">Imprimir</div><div>Relat√≥rio</div></div>
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Modal sele√ß√£o de aluno para PDF individual */}
                    {showStudentModal && report && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                                <h3 className="text-xl font-bold mb-4">Selecione o Aluno</h3>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {report.map(r => (
                                        <button key={r.student.id}
                                            onClick={() => { setSelectedStudent(r.student.id); setTimeout(generateIndividualPDF, 100); }}
                                            className="w-full text-left p-3 border-2 rounded-lg hover:bg-blue-50 hover:border-blue-500 transition">
                                            <div className="font-bold">{r.student.name}</div>
                                            <div className="text-sm text-gray-600">Presen√ßa: {r.percentage}%</div>
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setShowStudentModal(false)} className="w-full mt-4 bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Cancelar</button>
                            </div>
                        </div>
                    )}
                    
                    {report ? (
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <div className="text-center mb-6">
                                <h3 className="text-2xl font-bold">Relat√≥rio de Frequ√™ncia</h3>
                                <p className="text-gray-600 mt-2">{cls.name}</p>
                                <p className="text-sm text-gray-500">Per√≠odo: {fmtDate(startDate)} a {fmtDate(endDate)}</p>
                            </div>
                            <div className="space-y-3">
                                {report.map((r, idx) => (
                                    <div key={r.student.id} className="border-2 rounded-xl overflow-hidden">
                                        {/* Linha principal */}
                                        <div
                                            className={`flex items-center gap-3 p-4 cursor-pointer hover:bg-gray-50 transition ${expandedStudent === r.student.id ? 'bg-indigo-50 border-b-2 border-indigo-200' : ''}`}
                                            onClick={() => setExpandedStudent(expandedStudent === r.student.id ? null : r.student.id)}
                                        >
                                            <span className="font-bold text-sm bg-indigo-100 w-8 h-8 rounded-full flex items-center justify-center shrink-0">{idx + 1}</span>
                                            <div className="flex-1">
                                                <span className="font-bold text-base">{r.student.name}</span>
                                                <p className="text-xs text-gray-500">üìÜ Matr√≠cula: {r.enrollDate ? fmtDate(r.enrollDate) : 'N√£o informada'}{r.enrollDate && new Date(r.enrollDate + 'T00:00:00') > new Date(startDate + 'T00:00:00') ? <span className="ml-1 text-orange-600 font-semibold">(c√°lculo a partir de {fmtDate(r.enrollDate)})</span> : null}</p>
                                            </div>
                                            <div className="flex items-center gap-4 text-sm">
                                                <span className="text-green-600 font-bold">‚úÖ {r.presente}</span>
                                                <span className="text-red-600 font-bold">‚ùå {r.falta}</span>
                                                <span className="text-yellow-600 font-bold">üìù {r.justificada}</span>
                                                <span className="text-gray-500">Total: {r.total}</span>
                                                <span className={`font-bold text-base px-3 py-1 rounded-full ${parseFloat(r.percentage) >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {r.percentage}%
                                                </span>
                                                <span className="text-gray-400 text-lg">{expandedStudent === r.student.id ? '‚ñ≤' : '‚ñº'}</span>
                                            </div>
                                        </div>

                                        {/* Detalhes expandidos */}
                                        {expandedStudent === r.student.id && (
                                            <div className="p-4 bg-gray-50 grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {/* Faltas */}
                                                <div className="bg-white rounded-lg border-2 border-red-100 p-4">
                                                    <h4 className="font-bold text-red-600 mb-3 flex items-center gap-2">
                                                        ‚ùå Datas de Falta
                                                        <span className="bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded-full">{r.faltaDates.length}</span>
                                                    </h4>
                                                    {r.faltaDates.length === 0 ? (
                                                        <p className="text-sm text-gray-400 italic">Nenhuma falta no per√≠odo</p>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2">
                                                            {r.faltaDates.map(d => (
                                                                <span key={d} className="bg-red-50 border border-red-200 text-red-700 text-xs font-semibold px-3 py-1.5 rounded-lg">
                                                                    {fmtDate(d)}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Justificadas */}
                                                <div className="bg-white rounded-lg border-2 border-yellow-100 p-4">
                                                    <h4 className="font-bold text-yellow-600 mb-3 flex items-center gap-2">
                                                        üìù Datas Justificadas
                                                        <span className="bg-yellow-100 text-yellow-700 text-xs px-2 py-0.5 rounded-full">{r.justificadaDates.length}</span>
                                                    </h4>
                                                    {r.justificadaDates.length === 0 ? (
                                                        <p className="text-sm text-gray-400 italic">Nenhuma justificada no per√≠odo</p>
                                                    ) : (
                                                        <div className="flex flex-wrap gap-2">
                                                            {r.justificadaDates.map(d => (
                                                                <span key={d} className="bg-yellow-50 border border-yellow-200 text-yellow-700 text-xs font-semibold px-3 py-1.5 rounded-lg">
                                                                    {fmtDate(d)}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <div className="mt-6 flex gap-6 text-sm text-gray-600 flex-wrap">
                                <span>‚úÖ Total de Presen√ßas: <strong>{report.reduce((sum, r) => sum + r.presente, 0)}</strong></span>
                                <span>‚ùå Total de Faltas: <strong>{report.reduce((sum, r) => sum + r.falta, 0)}</strong></span>
                                <span>üìù Total de Justificadas: <strong>{report.reduce((sum, r) => sum + r.justificada, 0)}</strong></span>
                            </div>
                        </div>
                    ) : (
                        <div className="bg-white p-12 rounded-xl shadow-lg text-center">
                            <div className="text-6xl mb-4">üìä</div>
                            <p className="text-xl text-gray-600">Selecione uma turma para gerar o relat√≥rio</p>
                        </div>
                    )}
                </div>
            );
        }
        
        function History({ classes, showToast }) {
            const [filterStatus, setFilterStatus] = useState('todos');
            const [selectedClass, setSelectedClass] = useState(null);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [showReportModal, setShowReportModal] = useState(false);
            
            const getInactiveStudents = () => {
                try {
                    const students = [];
                    if (!classes || !Array.isArray(classes)) return students;
                    classes.forEach(cls => {
                        if (cls.students && Array.isArray(cls.students)) {
                            cls.students.filter(s => s.status && s.status !== 'ativo').forEach(s => {
                                students.push({ ...s, className: cls.name, classId: cls.id, exitDate: s.exitDate || null, exitObservation: s.exitObservation || '' });
                            });
                        }
                    });
                    return students;
                } catch (e) { return []; }
            };
            
            const allInactive = getInactiveStudents();
            const filteredStudents = filterStatus === 'todos' ? allInactive : allInactive.filter(s => s.status === filterStatus);
            const displayStudents = selectedClass ? filteredStudents.filter(s => s.classId === selectedClass) : filteredStudents;
            
            const generateStudentReport = (student) => {
                try {
                    let presente = 0, falta = 0, justificada = 0;
                    if (!student.exitDate) {
                        Object.entries(student.attendance || {}).forEach(([date, status]) => {
                            if (status === 'presente') presente++;
                            else if (status === 'falta') falta++;
                            else if (status === 'justificada') justificada++;
                        });
                    } else {
                        const exitDate = new Date(student.exitDate + 'T00:00:00');
                        Object.entries(student.attendance || {}).forEach(([date, status]) => {
                            const attDate = new Date(date + 'T00:00:00');
                            if (attDate <= exitDate) {
                                if (status === 'presente') presente++;
                                else if (status === 'falta') falta++;
                                else if (status === 'justificada') justificada++;
                            }
                        });
                    }
                    const total = presente + falta + justificada;
                    const percentage = total > 0 ? ((presente / total) * 100).toFixed(1) : 0;
                    return { student, presente, falta, justificada, total, percentage };
                } catch (e) { return null; }
            };
            
            const generateHistoryPDF = () => {
                if (!selectedStudent) return;
                const report = generateStudentReport(selectedStudent);
                if (!report) { showToast('Erro ao gerar relat√≥rio!', 'error'); return; }
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(20); doc.setFont(undefined, 'bold');
                    doc.text('Hist√≥rico de Frequ√™ncia do Aluno', 105, 20, { align: 'center' });
                    const statusText = selectedStudent.status === 'transferido' ? 'TRANSFERIDO' : 'FALECIDO';
                    const statusColor = selectedStudent.status === 'transferido' ? [255, 140, 0] : [100, 100, 100];
                    doc.setFontSize(14); doc.setTextColor(...statusColor);
                    doc.text(statusText, 105, 30, { align: 'center' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(12); doc.setFont(undefined, 'normal');
                    doc.text(`Turma: ${selectedStudent.className}`, 20, 45);
                    doc.text(`Aluno: ${selectedStudent.name}`, 20, 52);
                    if (selectedStudent.exitDate) doc.text(`Data de Sa√≠da: ${new Date(selectedStudent.exitDate + 'T00:00:00').toLocaleDateString('pt-BR')}`, 20, 59);
                    doc.setFontSize(14); doc.setFont(undefined, 'bold');
                    doc.text(selectedStudent.exitDate ? 'Frequ√™ncia at√© a Data de Sa√≠da:' : 'Frequ√™ncia Total:', 20, 75);
                    doc.setFontSize(12); doc.setFont(undefined, 'normal');
                    doc.text(`Presen√ßas: ${report.presente}`, 20, 85);
                    doc.text(`Faltas: ${report.falta}`, 20, 92);
                    doc.text(`Justificadas: ${report.justificada}`, 20, 99);
                    doc.text(`Total de Aulas: ${report.total}`, 20, 106);
                    doc.text(`Percentual de Presen√ßa: ${report.percentage}%`, 20, 113);
                    const status = parseFloat(report.percentage) >= 75 ? 'APROVADO' : 'REPROVADO por falta';
                    doc.setFontSize(14); doc.setFont(undefined, 'bold');
                    doc.text(`Situa√ß√£o Final: ${status}`, 20, 125);
                    if (selectedStudent.exitObservation) {
                        doc.setFontSize(10); doc.setFont(undefined, 'bold'); doc.text('Observa√ß√µes:', 20, 145);
                        doc.setFont(undefined, 'normal');
                        const lines = doc.splitTextToSize(selectedStudent.exitObservation, 170);
                        doc.text(lines, 20, 152);
                    }
                    doc.save(`historico_${selectedStudent.name.replace(/\s/g, '_')}.pdf`);
                    showToast('PDF do hist√≥rico gerado com sucesso!', 'success');
                    setShowReportModal(false);
                } catch (e) { showToast('Erro ao gerar PDF!', 'error'); }
            };
            
            return (
                <div className="space-y-6">
                    <div className="bg-white p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold mb-4">üìã Hist√≥rico de Alunos</h2>
                        <p className="text-gray-600 mb-4">Consulte alunos transferidos e falecidos com seus registros de frequ√™ncia</p>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üìå Filtrar por Status:</label>
                                <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                    <option value="todos">Todos</option>
                                    <option value="transferido">üîÑ Transferidos</option>
                                    <option value="falecido">üïäÔ∏è Falecidos</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-2">üè´ Filtrar por Turma:</label>
                                <select value={selectedClass || ''} onChange={(e) => setSelectedClass(Number(e.target.value) || null)}
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none">
                                    <option value="">Todas as turmas</option>
                                    {classes && classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div className="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                                <div className="text-2xl mb-1">üîÑ</div>
                                <div className="text-sm text-gray-600">Transferidos</div>
                                <div className="text-2xl font-bold text-orange-600">{allInactive.filter(s => s.status === 'transferido').length}</div>
                            </div>
                            <div className="bg-gray-100 p-4 rounded-lg border-2 border-gray-300">
                                <div className="text-2xl mb-1">üïäÔ∏è</div>
                                <div className="text-sm text-gray-600">Falecidos</div>
                                <div className="text-2xl font-bold text-gray-600">{allInactive.filter(s => s.status === 'falecido').length}</div>
                            </div>
                            <div className="bg-indigo-50 p-4 rounded-lg border-2 border-indigo-200">
                                <div className="text-2xl mb-1">üìä</div>
                                <div className="text-sm text-gray-600">Total</div>
                                <div className="text-2xl font-bold text-indigo-600">{allInactive.length}</div>
                            </div>
                        </div>
                    </div>
                    
                    {displayStudents.length === 0 ? (
                        <div className="bg-white p-12 rounded-xl shadow-lg text-center">
                            <div className="text-6xl mb-4">üìã</div>
                            <p className="text-xl text-gray-600">Nenhum aluno encontrado</p>
                        </div>
                    ) : (
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-bold mb-4">{displayStudents.length} aluno(s) encontrado(s)</h3>
                            <div className="space-y-3">
                                {displayStudents.map(student => {
                                    const report = generateStudentReport(student);
                                    return (
                                        <div key={student.id} className={`border-2 rounded-lg p-4 ${student.status === 'transferido' ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-300'}`}>
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3">
                                                        <span className="text-2xl">{student.status === 'transferido' ? 'üîÑ' : 'üïäÔ∏è'}</span>
                                                        <div>
                                                            <p className="font-bold text-lg">{student.name}</p>
                                                            <p className="text-sm text-gray-600">
                                                                {student.className} ‚Ä¢ {student.status === 'transferido' ? ' Transferido' : ' Falecido'}
                                                                {student.exitDate && ` em ${new Date(student.exitDate + 'T00:00:00').toLocaleDateString('pt-BR')}`}
                                                                {!student.exitDate && ' (sem data registrada)'}
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button onClick={() => { setSelectedStudent(student); setShowReportModal(true); }}
                                                    className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-indigo-700 transition">
                                                    üìÑ Ver Relat√≥rio
                                                </button>
                                            </div>
                                            {report && (
                                                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                                                    <div className="text-center p-2 bg-white rounded"><div className="text-green-600 font-bold">{report.presente}</div><div className="text-gray-600">Presen√ßas</div></div>
                                                    <div className="text-center p-2 bg-white rounded"><div className="text-red-600 font-bold">{report.falta}</div><div className="text-gray-600">Faltas</div></div>
                                                    <div className="text-center p-2 bg-white rounded"><div className="text-yellow-600 font-bold">{report.justificada}</div><div className="text-gray-600">Justificadas</div></div>
                                                    <div className="text-center p-2 bg-white rounded"><div className="font-bold">{report.total}</div><div className="text-gray-600">Total</div></div>
                                                    <div className="text-center p-2 bg-white rounded"><div className={`font-bold ${parseFloat(report.percentage) >= 75 ? 'text-green-600' : 'text-red-600'}`}>{report.percentage}%</div><div className="text-gray-600">Presen√ßa</div></div>
                                                </div>
                                            )}
                                            {student.exitObservation && (
                                                <div className="mt-3 p-3 bg-white rounded border-l-4 border-indigo-500">
                                                    <p className="text-sm font-semibold text-gray-700">Observa√ß√µes:</p>
                                                    <p className="text-sm text-gray-600 mt-1">{student.exitObservation}</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {showReportModal && selectedStudent && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto">
                                <h3 className="text-2xl font-bold mb-4">{selectedStudent.status === 'transferido' ? 'üîÑ' : 'üïäÔ∏è'} Relat√≥rio do Aluno</h3>
                                <div className="mb-6">
                                    <p className="text-lg font-bold">{selectedStudent.name}</p>
                                    <p className="text-gray-600">{selectedStudent.className}</p>
                                    {selectedStudent.exitDate ? (
                                        <p className="text-sm text-gray-500 mt-1">Data de sa√≠da: {new Date(selectedStudent.exitDate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                    ) : (
                                        <p className="text-sm text-yellow-600 mt-1">‚ö†Ô∏è Data de sa√≠da n√£o registrada</p>
                                    )}
                                </div>
                                {(() => {
                                    const report = generateStudentReport(selectedStudent);
                                    return report && (
                                        <div className="bg-gray-50 p-6 rounded-lg mb-6">
                                            <h4 className="font-bold mb-4">{selectedStudent.exitDate ? 'Frequ√™ncia at√© a Data de Sa√≠da:' : 'Frequ√™ncia Total:'}</h4>
                                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                                <div className="text-center p-4 bg-white rounded-lg"><div className="text-3xl font-bold text-green-600">{report.presente}</div><div className="text-sm text-gray-600">Presen√ßas</div></div>
                                                <div className="text-center p-4 bg-white rounded-lg"><div className="text-3xl font-bold text-red-600">{report.falta}</div><div className="text-sm text-gray-600">Faltas</div></div>
                                                <div className="text-center p-4 bg-white rounded-lg"><div className="text-3xl font-bold text-yellow-600">{report.justificada}</div><div className="text-sm text-gray-600">Justificadas</div></div>
                                                <div className="text-center p-4 bg-white rounded-lg"><div className="text-3xl font-bold">{report.total}</div><div className="text-sm text-gray-600">Total</div></div>
                                                <div className="text-center p-4 bg-white rounded-lg col-span-2">
                                                    <div className={`text-3xl font-bold ${parseFloat(report.percentage) >= 75 ? 'text-green-600' : 'text-red-600'}`}>{report.percentage}%</div>
                                                    <div className="text-sm text-gray-600">Percentual de Presen√ßa</div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {selectedStudent.exitObservation && (
                                    <div className="bg-yellow-50 p-4 rounded-lg mb-6 border-2 border-yellow-200">
                                        <p className="font-bold mb-2">üìù Observa√ß√µes:</p>
                                        <p className="text-gray-700">{selectedStudent.exitObservation}</p>
                                    </div>
                                )}
                                <div className="flex gap-3">
                                    <button onClick={generateHistoryPDF} className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition">üìÑ Gerar PDF</button>
                                    <button onClick={() => setShowReportModal(false)} className="flex-1 bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
         function ConfigModal({ onClose, showToast }) {
            const [apiKey, setApiKey] = useState(CloudSync.getKey());
            const [binId, setBinId] = useState(CloudSync.getBinId());
            const [keyType, setKeyType] = useState(CloudSync.getKeyType());
            const [showAdvanced, setShowAdvanced] = useState(false);
            const handleSave = () => {
                if (!apiKey.trim()) { showToast('Digite uma chave v√°lida!', 'error'); return; }
                localStorage.setItem('jsonbin_api_key', apiKey.trim());
                localStorage.setItem('jsonbin_key_type', keyType);
                if (binId.trim()) localStorage.setItem('syncBinId', binId.trim());
                showToast('Configura√ß√£o salva com sucesso!', 'success');
                onClose();
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-auto shadow-2xl">
                        <h2 className="text-2xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes de Sincroniza√ß√£o</h2>

                        <div className="bg-blue-50 p-5 rounded-lg mb-4 border-2 border-blue-200">
                            <h3 className="font-bold mb-2 text-blue-800">üîê Como usar a X-Access-Key (mais seguro)</h3>
                            <p className="text-sm text-gray-700 mb-2">Limita o acesso apenas ao bin de Frequ√™ncia Escolar. Mesmo que algu√©m veja a chave, n√£o acessa outros dados da sua conta.</p>
                            <ol className="list-decimal list-inside space-y-1 text-sm text-gray-700">
                                <li>No JSONBin v√° em <strong>API Keys</strong></li>
                                <li>Expanda <strong>"FREQUENCIA ESCOLAR"</strong> clicando na seta ‚ñº</li>
                                <li>Certifique que tem permiss√£o de <strong>Read + Update</strong></li>
                                <li>Copie a chave e cole no campo abaixo selecionando <strong>X-Access-Key</strong></li>
                                <li>No <code className="bg-gray-200 px-1 rounded">SHARED_CONFIG</code> do HTML coloque <code className="bg-gray-200 px-1 rounded">keyType: 'access'</code></li>
                            </ol>
                        </div>

                        <div className="bg-gradient-to-r from-green-50 to-blue-50 p-5 rounded-lg mb-4 border-2 border-green-200">
                            <h3 className="font-bold mb-2 text-lg">üéØ CONFIGURA√á√ÉO COMPARTILHADA (RECOMENDADO)</h3>
                            <div className="bg-white p-4 rounded-lg border-2 border-blue-300">
                                <p className="font-bold text-blue-700 mb-2">‚úÖ Para que TODOS acessem com o mesmo link:</p>
                                <ol className="list-decimal list-inside space-y-1 text-sm">
                                    <li>Abra o arquivo HTML em um editor de texto</li>
                                    <li>Procure por <code className="bg-gray-200 px-1 rounded">SHARED_CONFIG</code></li>
                                    <li>Cole sua chave em <code className="bg-gray-200 px-1 rounded">apiKey: ''</code></li>
                                    <li>Defina <code className="bg-gray-200 px-1 rounded">keyType: 'master'</code> ou <code className="bg-gray-200 px-1 rounded">'access'</code></li>
                                    <li>Cole o BIN ID em <code className="bg-gray-200 px-1 rounded">binId: ''</code></li>
                                    <li>Salve e compartilhe!</li>
                                </ol>
                            </div>
                        </div>

                        <button onClick={() => setShowAdvanced(!showAdvanced)} className="w-full mb-4 bg-gray-200 py-2 rounded-lg font-bold hover:bg-gray-300 transition">
                            {showAdvanced ? '‚ñº' : '‚ñ∂'} Configura√ß√£o Individual (Avan√ßado)
                        </button>
                        {showAdvanced && (
                            <>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">üîë Chave da API:</label>
                                    <input type="text" value={apiKey} onChange={(e) => setApiKey(e.target.value)}
                                        placeholder="Cole sua X-Master-Key ou X-Access-Key aqui..."
                                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none font-mono text-sm" />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">üè∑Ô∏è Tipo de Chave:</label>
                                    <div className="flex gap-3">
                                        <label className={`flex-1 flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition ${keyType === 'master' ? 'border-indigo-500 bg-indigo-50' : 'border-gray-300 hover:border-gray-400'}`}>
                                            <input type="radio" name="keyType" value="master" checked={keyType === 'master'} onChange={() => setKeyType('master')} />
                                            <div>
                                                <div className="font-bold text-sm">X-Master-Key</div>
                                                <div className="text-xs text-gray-500">Acesso total √† conta JSONBin</div>
                                            </div>
                                        </label>
                                        <label className={`flex-1 flex items-center gap-3 p-3 border-2 rounded-lg cursor-pointer transition ${keyType === 'access' ? 'border-green-500 bg-green-50' : 'border-gray-300 hover:border-gray-400'}`}>
                                            <input type="radio" name="keyType" value="access" checked={keyType === 'access'} onChange={() => setKeyType('access')} />
                                            <div>
                                                <div className="font-bold text-sm text-green-700">‚úÖ X-Access-Key</div>
                                                <div className="text-xs text-gray-500">Acesso limitado ao bin (mais seguro)</div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-bold text-gray-700 mb-2">üÜî BIN ID (opcional):</label>
                                    <input type="text" value={binId} onChange={(e) => setBinId(e.target.value)}
                                        placeholder="Cole o BIN ID..."
                                        className="w-full px-4 py-3 border-2 rounded-lg focus:border-indigo-500 outline-none font-mono text-sm" />
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleSave} className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">‚úÖ Salvar</button>
                                    <button onClick={onClose} className="flex-1 bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Cancelar</button>
                                </div>
                            </>
                        )}
                        {!showAdvanced && (
                            <button onClick={onClose} className="w-full bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Fechar</button>
                        )}
                    </div>
                </div>
            );
        }
        
        function UsersModal({ users, setUsers, onClose, showToast }) {
            const [login, setLogin] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [role, setRole] = useState('viewer');
            const [editingUser, setEditingUser] = useState(null);
            const [newPassword, setNewPassword] = useState('');
            
            const handleAdd = () => {
                if (!login.trim() || !password.trim() || !name.trim()) { showToast('Preencha todos os campos!', 'error'); return; }
                if (users[login]) { showToast('Este login j√° existe!', 'error'); return; }
                setUsers({ ...users, [login]: { password, name, role } });
                showToast(`Usu√°rio ${name} criado com sucesso!`, 'success');
                setLogin(''); setPassword(''); setName(''); setRole('viewer');
            };
            
            const handleChangePassword = (userLogin) => {
                if (!newPassword.trim()) { showToast('Digite a nova senha!', 'error'); return; }
                const updatedUsers = { ...users, [userLogin]: { ...users[userLogin], password: newPassword.trim() } };
                setUsers(updatedUsers);
                showToast(`Senha de ${users[userLogin].name} alterada!`, 'success');
                setEditingUser(null); setNewPassword('');
            };
            
            const handleDelete = (userLogin) => {
                if (userLogin === 'admin') { showToast('N√£o √© poss√≠vel excluir o administrador principal!', 'error'); return; }
                if (confirm(`‚ö†Ô∏è Excluir o usu√°rio "${users[userLogin].name}"?`)) {
                    const newUsers = { ...users };
                    delete newUsers[userLogin];
                    setUsers(newUsers);
                    showToast('Usu√°rio exclu√≠do com sucesso!', 'success');
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-auto shadow-2xl">
                        <h2 className="text-2xl font-bold mb-4">üë• Gerenciar Usu√°rios</h2>
                        <div className="bg-green-50 p-4 rounded-lg mb-4 border-2 border-green-200">
                            <h3 className="font-bold mb-3">‚ûï Criar Novo Usu√°rio</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
                                <input value={login} onChange={(e) => setLogin(e.target.value)} placeholder="Login (usu√°rio)" className="px-4 py-3 border-2 rounded-lg focus:border-green-500 outline-none" />
                                <input value={password} onChange={(e) => setPassword(e.target.value)} type="password" placeholder="Senha" className="px-4 py-3 border-2 rounded-lg focus:border-green-500 outline-none" />
                                <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Nome completo" className="px-4 py-3 border-2 rounded-lg focus:border-green-500 outline-none" />
                                <select value={role} onChange={(e) => setRole(e.target.value)} className="px-4 py-3 border-2 rounded-lg focus:border-green-500 outline-none bg-white">
                                    <option value="admin">üëë Administrador (acesso total)</option>
                                    <option value="editor">‚úèÔ∏è Editor (preenche chamada)</option>
                                    <option value="viewer">üëÅÔ∏è Visualizador (somente leitura)</option>
                                </select>
                            </div>
                            <div className="mb-3 bg-blue-50 p-3 rounded-lg border border-blue-200 text-sm text-blue-800">
                                <strong>Permiss√µes por perfil:</strong><br/>
                                üëë <strong>Admin:</strong> tudo (turmas, alunos, usu√°rios, PDFs, hist√≥rico)<br/>
                                ‚úèÔ∏è <strong>Editor:</strong> dashboard + preenchimento de chamada + relat√≥rios (sem PDF)<br/>
                                üëÅÔ∏è <strong>Visualizador:</strong> dashboard + visualiza√ß√£o de chamada + relat√≥rios (sem PDF)
                            </div>
                            <button onClick={handleAdd} className="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition">‚úÖ Criar Usu√°rio</button>
                        </div>
                        <div className="space-y-2">
                            <h3 className="font-bold mb-2">üìã Usu√°rios Cadastrados:</h3>
                            {Object.entries(users).map(([userLogin, userData]) => (
                                <div key={userLogin} className="border-2 rounded-lg p-4 bg-white hover:bg-gray-50 transition">
                                    <div className="flex items-center gap-3 mb-3">
                                        <div className="flex-1">
                                            <p className="font-bold text-lg">{userData.name}</p>
                                            <p className="text-sm text-gray-600">Login: {userLogin} | Fun√ß√£o: {userData.role === 'admin' ? 'üëë Admin' : userData.role === 'editor' ? '‚úèÔ∏è Editor' : 'üëÅÔ∏è Visualizador'}</p>
                                        </div>
                                        <button onClick={() => setEditingUser(editingUser === userLogin ? null : userLogin)}
                                            className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">
                                            üîë {editingUser === userLogin ? 'Cancelar' : 'Alterar Senha'}
                                        </button>
                                        {userLogin !== 'admin' && (
                                            <button onClick={() => handleDelete(userLogin)} className="text-red-600 px-4 py-2 hover:bg-red-50 rounded-lg font-semibold transition">üóëÔ∏è Excluir</button>
                                        )}
                                    </div>
                                    {editingUser === userLogin && (
                                        <div className="bg-yellow-50 p-3 rounded-lg border-2 border-yellow-200">
                                            <h4 className="font-bold mb-2 text-sm">üîë Alterar Senha de {userData.name}</h4>
                                            <div className="flex gap-2">
                                                <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)}
                                                    placeholder="Digite a nova senha"
                                                    className="flex-1 px-4 py-2 border-2 rounded-lg focus:border-yellow-500 outline-none"
                                                    onKeyPress={(e) => e.key === 'Enter' && handleChangePassword(userLogin)} />
                                                <button onClick={() => handleChangePassword(userLogin)}
                                                    className="bg-yellow-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-yellow-700 transition">‚úÖ Salvar</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                        <button onClick={onClose} className="w-full mt-4 bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Fechar</button>
                    </div>
                </div>
            );
        }
        
        function ClassesModal({ classes, setClasses, onClose, showToast }) {
            const [name, setName] = useState('');
            const handleAdd = () => {
                if (!name.trim()) { showToast('Digite o nome da turma!', 'error'); return; }
                setClasses([...classes, { id: Date.now(), name: name.trim(), students: [] }]);
                showToast(`Turma "${name.trim()}" criada com sucesso!`, 'success');
                setName('');
            };
            const handleDelete = (id) => {
                const cls = classes.find(c => c.id === id);
                if (confirm(`‚ö†Ô∏è Excluir a turma "${cls.name}"? Todos os dados ser√£o perdidos!`)) {
                    setClasses(classes.filter(c => c.id !== id));
                    showToast('Turma exclu√≠da com sucesso!', 'success');
                }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
                        <h2 className="text-2xl font-bold mb-4">üè´ Gerenciar Turmas</h2>
                        <div className="bg-green-50 p-4 rounded-lg mb-4 border-2 border-green-200">
                            <h3 className="font-bold mb-3">‚ûï Criar Nova Turma</h3>
                            <div className="flex gap-2">
                                <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Nome da turma (ex: 5¬∫ Ano A)"
                                    className="flex-1 px-4 py-3 border-2 rounded-lg focus:border-green-500 outline-none"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAdd()} />
                                <button onClick={handleAdd} className="bg-green-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-green-700 transition">‚úÖ Criar</button>
                            </div>
                        </div>
                        <div className="space-y-2 mb-4">
                            <h3 className="font-bold mb-2">üìã Turmas Cadastradas ({classes.length}):</h3>
                            {classes.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">Nenhuma turma cadastrada</p>
                            ) : (
                                <div className="max-h-96 overflow-y-auto space-y-2">
                                    {classes.map(c => (
                                        <div key={c.id} className="flex items-center gap-3 p-4 border-2 rounded-lg bg-white hover:bg-gray-50 transition">
                                            <div className="flex-1"><p className="font-bold text-lg">{c.name}</p><p className="text-sm text-gray-600">{c.students.length} aluno(s)</p></div>
                                            <button onClick={() => handleDelete(c.id)} className="text-red-600 px-4 py-2 hover:bg-red-50 rounded-lg font-semibold transition">üóëÔ∏è Excluir</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                        <div className="sticky bottom-0 bg-white pt-4 border-t-2">
                            <button onClick={onClose} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition shadow-lg">‚ùå Fechar</button>
                        </div>
                    </div>
                </div>
            );
        }
        
        function StudentsModal({ class: cls, classes, setClasses, onClose, showToast }) {
            const [name, setName] = useState('');
            const [bulkInput, setBulkInput] = useState('');
            const [showBulkAdd, setShowBulkAdd] = useState(false);
            const [editingExit, setEditingExit] = useState(null);
            const [exitDate, setExitDate] = useState(new Date().toISOString().split('T')[0]);
            const [exitObservation, setExitObservation] = useState('');
            const [posCenso, setPosCenso] = useState(false);
            const [enrollDate, setEnrollDate] = useState(new Date().toISOString().split('T')[0]);
            
            const sortStudents = (students) => {
                const normais = students.filter(s => !s.posCenso).sort((a, b) => a.name.localeCompare(b.name));
                const pc = students.filter(s => s.posCenso).sort((a, b) => a.name.localeCompare(b.name));
                return [...normais, ...pc];
            };
            
            const handleAdd = () => {
                if (!name.trim()) { showToast('Digite o nome do aluno!', 'error'); return; }
                const newStudent = { id: Date.now(), name: name.trim(), status: 'ativo', posCenso, enrollDate, attendance: {}, observations: {}, exitDate: null, exitObservation: '' };
                setClasses(classes.map(c => c.id === cls.id ? { ...c, students: sortStudents([...c.students, newStudent]) } : c));
                showToast(`Aluno ${posCenso ? '(P√≥s-censo) ' : ''}adicionado com sucesso!`, 'success');
                setName(''); setPosCenso(false); setEnrollDate(new Date().toISOString().split('T')[0]);
            };
            
            const handleBulkAdd = () => {
                if (!bulkInput.trim()) { showToast('Cole a lista de alunos!', 'error'); return; }
                const lines = bulkInput.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                if (lines.length === 0) { showToast('Nenhum nome v√°lido encontrado!', 'error'); return; }
                const newStudents = lines.map((studentName, index) => ({ id: Date.now() + index, name: studentName, status: 'ativo', posCenso, enrollDate, attendance: {}, observations: {}, exitDate: null, exitObservation: '' }));
                setClasses(classes.map(c => c.id === cls.id ? { ...c, students: sortStudents([...c.students, ...newStudents]) } : c));
                showToast(`${newStudents.length} aluno(s) adicionado(s) com sucesso!`, 'success');
                setBulkInput(''); setShowBulkAdd(false); setPosCenso(false); setEnrollDate(new Date().toISOString().split('T')[0]);
            };
            
            const handleStatusChange = (studentId, newStatus) => {
                setClasses(classes.map(c => c.id === cls.id ? { ...c, students: c.students.map(s => s.id === studentId ? { ...s, status: newStatus } : s) } : c));
                if (newStatus !== 'ativo') {
                    const student = cls.students.find(s => s.id === studentId);
                    setEditingExit(studentId);
                    setExitDate(student.exitDate || new Date().toISOString().split('T')[0]);
                    setExitObservation(student.exitObservation || '');
                } else {
                    setClasses(classes.map(c => c.id === cls.id ? { ...c, students: c.students.map(s => s.id === studentId ? { ...s, status: newStatus, exitDate: null, exitObservation: '' } : s) } : c));
                }
            };
            
            const confirmStatusChange = (studentId) => {
                if (!exitDate) { showToast('Digite a data de sa√≠da!', 'error'); return; }
                const currentStudent = cls.students.find(s => s.id === studentId);
                setClasses(classes.map(c => c.id === cls.id ? { ...c, students: c.students.map(s => s.id === studentId ? { ...s, exitDate, exitObservation: exitObservation.trim() } : s) } : c));
                const statusText = currentStudent.status === 'transferido' ? 'Transfer√™ncia' : 'Falecimento';
                showToast(`${statusText} registrado com sucesso!`, 'success');
                setEditingExit(null); setExitDate(new Date().toISOString().split('T')[0]); setExitObservation('');
            };
            
            const handleDelete = (studentId) => {
                const student = cls.students.find(s => s.id === studentId);
                if (confirm(`‚ö†Ô∏è Excluir o aluno "${student.name}"? Todos os registros ser√£o perdidos!`)) {
                    setClasses(classes.map(c => c.id === cls.id ? { ...c, students: c.students.filter(s => s.id !== studentId) } : c));
                    showToast('Aluno exclu√≠do com sucesso!', 'success');
                }
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-3xl max-h-[90vh] overflow-auto shadow-2xl">
                        <h2 className="text-2xl font-bold mb-4">üë®‚Äçüéì Gerenciar Alunos - {cls.name}</h2>
                        <div className="flex gap-2 mb-4">
                            <button onClick={() => setShowBulkAdd(false)} className={`flex-1 py-2 rounded-lg font-bold transition ${!showBulkAdd ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>‚ûï Adicionar Individual</button>
                            <button onClick={() => setShowBulkAdd(true)} className={`flex-1 py-2 rounded-lg font-bold transition ${showBulkAdd ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>üìã Adicionar V√°rios</button>
                        </div>
                        {!showBulkAdd ? (
                            <div className="bg-blue-50 p-4 rounded-lg mb-4 border-2 border-blue-200">
                                <h3 className="font-bold mb-3">‚ûï Adicionar Novo Aluno</h3>
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <input value={name} onChange={(e) => setName(e.target.value)} placeholder="Nome completo do aluno"
                                            className="flex-1 px-4 py-3 border-2 rounded-lg focus:border-blue-500 outline-none"
                                            onKeyPress={(e) => e.key === 'Enter' && handleAdd()} />
                                        <button onClick={handleAdd} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition">‚úÖ Adicionar</button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" checked={posCenso} onChange={(e) => setPosCenso(e.target.checked)} className="w-5 h-5 rounded border-2 border-blue-500" />
                                            <span className="font-semibold text-blue-800">üìÖ Matr√≠cula P√≥s-Censo</span>
                                        </label>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-1">üìÜ Data de Matr√≠cula:</label>
                                            <input type="date" value={enrollDate} onChange={(e) => setEnrollDate(e.target.value)}
                                                className="w-full px-3 py-2 border-2 rounded-lg focus:border-blue-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="bg-purple-50 p-4 rounded-lg mb-4 border-2 border-purple-200">
                                <h3 className="font-bold mb-3">üìã Adicionar V√°rios Alunos de Uma Vez</h3>
                                <p className="text-sm text-gray-600 mb-3">Cole a lista de alunos abaixo (um nome por linha):</p>
                                <textarea value={bulkInput} onChange={(e) => setBulkInput(e.target.value)}
                                    placeholder="Jo√£o Silva&#10;Maria Santos&#10;Pedro Oliveira"
                                    className="w-full px-4 py-3 border-2 rounded-lg focus:border-purple-500 outline-none resize-none font-mono text-sm" rows="8" />
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 my-3">
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" checked={posCenso} onChange={(e) => setPosCenso(e.target.checked)} className="w-5 h-5 rounded border-2 border-purple-500" />
                                        <span className="font-semibold text-purple-800">üìÖ Matr√≠cula P√≥s-Censo</span>
                                    </label>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-1">üìÜ Data de Matr√≠cula (todos):</label>
                                        <input type="date" value={enrollDate} onChange={(e) => setEnrollDate(e.target.value)}
                                            className="w-full px-3 py-2 border-2 rounded-lg focus:border-purple-500 outline-none" />
                                    </div>
                                </div>
                                <button onClick={handleBulkAdd} className="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition">‚úÖ Adicionar Todos os Alunos</button>
                            </div>
                        )}
                        <div className="space-y-2">
                            <h3 className="font-bold mb-2">üìã Alunos da Turma ({cls.students.length}):</h3>
                            {cls.students.length === 0 ? (
                                <p className="text-gray-500 text-center py-4">Nenhum aluno cadastrado</p>
                            ) : (
                                (() => {
                                    const sorted = sortStudents(cls.students);
                                    return sorted.map((s, index) => (
                                        <div key={s.id} className={`border-2 rounded-lg p-4 transition ${s.posCenso ? 'bg-yellow-50 border-yellow-300' : 'bg-white hover:bg-gray-50'}`}>
                                            <div className="flex items-center gap-3 mb-2">
                                                <span className="font-bold text-sm bg-indigo-100 w-8 h-8 rounded-full flex items-center justify-center">{index + 1}</span>
                                                <div className="flex-1">
                                                    <span className="font-bold text-lg">{s.name}</span>
                                                    {s.posCenso && <span className="ml-2 text-xs bg-yellow-500 text-white px-2 py-1 rounded-full font-semibold">üìÖ P√ìS-CENSO</span>}
                                                    <p className="text-xs text-gray-500 mt-0.5">üìÜ Matr√≠cula: {s.enrollDate ? new Date(s.enrollDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o informada'}</p>
                                                </div>
                                                <select value={s.status} onChange={(e) => handleStatusChange(s.id, e.target.value)} disabled={editingExit === s.id}
                                                    className="px-4 py-2 border-2 rounded-lg focus:border-indigo-500 outline-none bg-white">
                                                    <option value="ativo">‚úÖ Ativo</option>
                                                    <option value="transferido">üîÑ Transferido</option>
                                                    <option value="falecido">üïäÔ∏è Falecido</option>
                                                </select>
                                                <button onClick={() => handleDelete(s.id)} className="text-red-600 px-4 py-2 hover:bg-red-50 rounded-lg font-semibold transition">üóëÔ∏è Excluir</button>
                                            </div>
                                            {editingExit === s.id && (
                                                <div className="mt-3 p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border-2 border-yellow-400 shadow-lg">
                                                    <div className="flex items-center gap-3 mb-3">
                                                        <span className="text-3xl">{s.status === 'transferido' ? 'üîÑ' : 'üïäÔ∏è'}</span>
                                                        <div>
                                                            <h4 className="font-bold text-yellow-800">{s.status === 'transferido' ? 'Registrar Transfer√™ncia' : 'Registrar Falecimento'}</h4>
                                                            <p className="text-sm text-yellow-700">‚ö†Ô∏è Preencha os dados abaixo e clique em Confirmar</p>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-3">
                                                        <div>
                                                            <label className="block text-sm font-bold text-gray-700 mb-1">üìÖ Data:</label>
                                                            <input type="date" value={exitDate} onChange={(e) => setExitDate(e.target.value)} className="w-full px-4 py-2 border-2 rounded-lg focus:border-yellow-500 outline-none" />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-bold text-gray-700 mb-1">üìù Observa√ß√µes (opcional):</label>
                                                            <textarea value={exitObservation} onChange={(e) => setExitObservation(e.target.value)}
                                                                placeholder="Ex: Transferido para Escola Municipal X..."
                                                                className="w-full px-4 py-2 border-2 rounded-lg focus:border-yellow-500 outline-none resize-none" rows="3" />
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => confirmStatusChange(s.id)} className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700 transition">‚úÖ Confirmar</button>
                                                            <button onClick={() => { setEditingExit(null); setExitDate(new Date().toISOString().split('T')[0]); setExitObservation(''); }}
                                                                className="flex-1 bg-gray-200 py-2 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Cancelar</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            {s.status !== 'ativo' && s.exitDate && editingExit !== s.id && (
                                                <div className="mt-2 p-3 bg-gray-50 rounded border-l-4 border-gray-400">
                                                    <p className="text-sm"><span className="font-semibold">Data de sa√≠da:</span> {new Date(s.exitDate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                                                    {s.exitObservation && <p className="text-sm mt-1"><span className="font-semibold">Obs:</span> {s.exitObservation}</p>}
                                                </div>
                                            )}
                                        </div>
                                    ));
                                })()
                            )}
                        </div>
                        <button onClick={onClose} className="w-full mt-4 bg-gray-200 py-3 rounded-lg font-bold hover:bg-gray-300 transition">‚ùå Fechar</button>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
